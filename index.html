<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="è²¨å¹£è½‰æ›èˆ‡è¨ˆç®—å·¥å…·">
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="currency_converter.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192x192.png">
  <link rel="apple-touch-icon" href="icon-192x192.png">
  <title>å•†å“åƒ¹æ ¼æ›ç®—å™¨</title>
  <script>
    // è¨»å†Š Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(registration => {
            console.log('ServiceWorker registration successful');
          })
          .catch(err => {
            console.log('ServiceWorker registration failed: ', err);
          });
      });
    }
  </script>
</head>
<body>
  <div class="main-container">
    <div class="left-container">
      <div class="tab-container">
        <button class="tab-button active" onclick="switchTab('converter')">è²¨å¹£è½‰æ›å™¨</button>
        <button class="tab-button" onclick="switchTab('settings')">è²¨å¹£è¨­å®š</button>
      </div>

      <div id="converter" class="tab-content active">
        <div class="currency-form-group">
          <!-- éš±è—çš„åŸå§‹selectå…ƒç´  -->
          <select class="currency-form-select hidden" id="fromCurrency" title="é¸æ“‡ä¾†æºè²¨å¹£">
            <option value="TWD">æ–°å°å¹£ (TWD)</option>
          </select>
          
          <!-- è‡ªè¨‚ä¸‹æ‹‰é¸å–® -->
          <div class="custom-select-container">
            <div id="fromCurrencySelected" class="custom-select-selected">
              <span>è«‹é¸æ“‡è²¨å¹£</span>
            </div>
            <div id="fromCurrencyOptions" class="custom-select-options"></div>
          </div>
          
          <input type="number" class="currency-form-input" id="amount" placeholder="è¼¸å…¥é‡‘é¡">
          <button class="currency-calculate-button" onclick="calculate()">è½‰æ›æˆå°å¹£</button>
        </div>
        <div class="currency-result-container" id="currencyResult"></div>
      </div>

      <div id="settings" class="tab-content">
        <div class="currency-management-container">
          <h3>åŒ¯ç‡ç®¡ç†</h3>
          
          <form id="editRateForm" class="currency-form">
            <div class="currency-form-group">
              <label for="editCurrency">é¸æ“‡è²¨å¹£ï¼š</label>
              
              <!-- éš±è—çš„åŸå§‹selectå…ƒç´  -->
              <select id="editCurrency" class="currency-form-select hidden">
                <option value="">è«‹é¸æ“‡è²¨å¹£</option>
                <option value="new">+ æ–°å¢è²¨å¹£...</option>
              </select>
              
              <!-- è‡ªè¨‚ä¸‹æ‹‰é¸å–® -->
              <div class="custom-select-container">
                <div id="editCurrencySelected" class="custom-select-selected">
                  <span>è«‹é¸æ“‡è²¨å¹£</span>
                </div>
                <div id="editCurrencyOptions" class="custom-select-options">
                  <div class="custom-select-option" data-value="">
                    <span>è«‹é¸æ“‡è²¨å¹£</span>
                  </div>
                  <div class="custom-select-option" data-value="new">
                    <span class="currency-icon"><i class="fas fa-plus-circle"></i></span>
                    <span>æ–°å¢è²¨å¹£...</span>
                  </div>
                </div>
              </div>
            </div>
            
            <div id="newCurrencyInputs" class="currency-new-inputs hidden">
              <div class="currency-form-group">
                <label for="customCode">è²¨å¹£ä»£ç¢¼ï¼š</label>
                <input type="text" id="customCode" class="currency-form-input" placeholder="USD" maxlength="5">
              </div>
              <div class="currency-form-group">
                <label for="customName">è²¨å¹£åç¨±ï¼š</label>
                <input type="text" id="customName" class="currency-form-input" placeholder="ç¾å…ƒ">
              </div>
            </div>
            
            <div class="currency-form-group">
              <label for="editRate">åŒ¯ç‡ (1å–®ä½=å¤šå°‘å°å¹£)ï¼š</label>
              <input type="number" id="editRate" class="currency-form-input" step="0.0001" min="0">
            </div>
            
            <div class="currency-form-actions">
              <button type="button" id="saveCurrencyBtn" class="currency-primary-button">ä¿®æ”¹åŒ¯ç‡</button>
              <button type="button" id="deleteCurrencyBtn" class="currency-danger-button hidden">åˆªé™¤è²¨å¹£</button>
            </div>
          </form>
        </div>
        <div class="currency-table-container">
          <table class="currency-table">
            <caption class="currency-table-caption">å·²è¨­å®šè²¨å¹£åˆ—è¡¨</caption>
            <thead>
              <tr>
                <th>è²¨å¹£</th>
                <th>åŒ¯ç‡</th>
                <th>è¨­å®šæ™‚é–“</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="currencyList"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="right-container">
      <div class="currency-live-rates-container">
        <h2 class="currency-live-rates-title"> ğŸ“¦å•†å“å”®åƒ¹è¨ˆç®—å™¨</h2>
        <div id="price-calculator" class="calculator-content">
          <div class="platform-select-container">
            <label>éŠ·å”®å¹³å°ï¼š</label>
            <select id="platform" onchange="toggleShopeeOptions()" class="currency-form-select" aria-label="é¸æ“‡éŠ·å”®å¹³å°">
              <option value="normal">ä¸€èˆ¬éŠ·å”®</option>
              <option value="shopee">è¦çš®</option>
            </select>
          </div>

          <div id="shopeeOptions" class="shopee-options hidden">
            <label class="shopee-option-label"><input type="checkbox" id="transactionFee" checked disabled> æˆäº¤æ‰‹çºŒè²» (5.5%)</label>
            <label class="shopee-option-label"><input type="checkbox" id="coinReward" onchange="handleCoinRewardChange(this)"> è¦å¹£å›é¥‹å°ˆæ¡ˆ (3%)</label>
            <label class="shopee-option-label"><input type="checkbox" id="coinReward15" onchange="handleCoinRewardChange(this)"> è¦å¹£å›é¥‹å°ˆæ¡ˆ (1.5%)</label>
            <label class="shopee-option-label"><input type="checkbox" id="freeShipping"> å…é‹è£œè²¼å°ˆæ¡ˆ (7%)</label>
            <label class="shopee-option-label"><input type="checkbox" id="processingFee" checked disabled> é‡‘æµèˆ‡ç³»çµ±è™•ç†è²» (2%)</label>
          </div>

          <div class="currency-form-group">
            <label>å•†å“å”®åƒ¹ï¼ˆå«ç¨…ï¼‰ï¼š</label>
            <input type="number" id="price" placeholder="ä¾‹å¦‚ï¼š1000" class="currency-form-input">
          </div>

          <div class="currency-form-group">
            <label>é€²è²¨æˆæœ¬ï¼š</label>
            <input type="number" id="cost" placeholder="ä¾‹å¦‚ï¼š800" class="currency-form-input">
          </div>

          <div class="currency-form-group">
            <label>ç›®æ¨™ç¨…å¾Œæ·¨åˆ©ç‡ï¼ˆ%ï¼‰ï¼š</label>
            <input type="number" id="targetProfitPercent" placeholder="ä¾‹å¦‚ï¼š10" class="currency-form-input">
          </div>

          <button onclick="calculateAll()" class="currency-calculate-button">è¨ˆç®—</button>

          <div id="priceResult" class="currency-result-container"></div>
        </div>
      </div>

      <div class="currency-live-rates-container">
        <h2 class="currency-live-rates-title">ğŸ’±å³æ™‚åŒ¯ç‡</h2>
        <div class="currency-coverage-info">
          å³æ™‚åŒ¯ç‡æ›´æ–°æˆåŠŸç‡: <span id="coverageRate">0%</span>
        </div>
        <div class="currency-rate-header">
          <div class="currency-info-header">è²¨å¹£</div>
          <div class="currency-rate-info-header">
            <div class="currency-live-rate-header">å³æ™‚</div>
            <div class="currency-set-rate-header">è¨­å®š</div>
            <div class="currency-rate-time-header">æ›´æ–°</div>
          </div>
        </div>
        <ul class="currency-live-rates-list" id="liveRates"></ul>
        <div class="currency-update-time" id="updateTime"></div>
        <button class="currency-refresh-button" onclick="updateLiveRates()">æ›´æ–°åŒ¯ç‡</button>
      </div>
    </div>
  </div>

  <script>
    // åˆå§‹åŒ–è²¨å¹£åˆ—è¡¨
    let currencies = JSON.parse(localStorage.getItem('currencies')) || {
      'TWD': { name: 'æ–°å°å¹£', rate: 1, time: new Date().toISOString() },
      'USD': { name: 'ç¾å…ƒ', rate: 0.033, time: new Date().toISOString() },
      'JPY': { name: 'æ—¥åœ“', rate: 3.7, time: new Date().toISOString() },
      'EUR': { name: 'æ­å…ƒ', rate: 0.03, time: new Date().toISOString() }
    };

    // é è¨­å¯æ·»åŠ çš„è²¨å¹£åˆ—è¡¨
    const AVAILABLE_CURRENCIES = {
      'USD': 'ç¾å…ƒ',
      'JPY': 'æ—¥åœ“',
      'EUR': 'æ­å…ƒ',
      'GBP': 'è‹±éŠ',
      'CNY': 'äººæ°‘å¹£',
      'KRW': 'éŸ“å…ƒ',
      'AUD': 'æ¾³å¹£',
      'CAD': 'åŠ å¹£',
      'SGD': 'æ–°åŠ å¡å¹£',
      'HKD': 'æ¸¯å¹£',
      'BTC': 'æ¯”ç‰¹å¹£',
      'ETH': 'ä»¥å¤ªå¹£',
      'USDT': 'æ³°é”å¹£',
      'BNB': 'å¹£å®‰å¹£',
      'SOL': 'ç´¢æ‹‰ç´',
      'XRP': 'ç‘æ³¢å¹£',
      'ADA': 'è‰¾é”å¹£',
      'DOGE': 'ç‹—ç‹—å¹£'
    };

    // API ä¾†æºè¨­å®š
    const API_SOURCES = {
      EXCHANGERATE_API: {
        name: 'ExchangeRate-API',
        url: (code) => `https://open.er-api.com/v6/latest/${code}`,
        parse: (data) => ({
          rate: data.rates['TWD'],
          time: data.time_last_update_utc,
          source: 'ExchangeRate-API'
        })
      },
      COINGECKO: {
        name: 'CoinGecko',
        url: (code) => `https://api.coingecko.com/api/v3/simple/price?ids=${CRYPTO_CURRENCIES[code]}&vs_currencies=twd`,
        parse: (data, code) => ({
          rate: data[CRYPTO_CURRENCIES[code]].twd,
          time: new Date().toISOString(),
          source: 'CoinGecko'
        })
      },
      BINANCE: {
        name: 'Binance',
        url: (code) => `https://api.binance.com/api/v3/ticker/price?symbol=${code}USDT`,
        parse: async (data) => {
          // ç²å– USDT/TWD åŒ¯ç‡
          const usdtResponse = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=tether&vs_currencies=twd');
          const usdtData = await usdtResponse.json();
          if (usdtData.tether && usdtData.tether.twd) {
            const rate = parseFloat(data.price) * usdtData.tether.twd;
            return {
              rate: rate,
              time: new Date().toISOString(),
              source: 'Binance + CoinGecko'
            };
          }
          return null;
        }
      }
    };

    // åŠ å¯†è²¨å¹£åˆ—è¡¨èˆ‡å°æ‡‰çš„ CoinGecko ID
    const CRYPTO_CURRENCIES = {
      'BTC': 'bitcoin',
      'ETH': 'ethereum',
      'USDT': 'tether',
      'BNB': 'binancecoin',
      'SOL': 'solana',
      'XRP': 'ripple',
      'ADA': 'cardano',
      'DOGE': 'dogecoin'
    };

    // è²¨å¹£åœ–ç¤ºè¨­å®š
    const CURRENCY_ICONS = {
      'BTC': '<i class="fab fa-bitcoin"></i>',
      'ETH': '<i class="fab fa-ethereum"></i>',
      'USDT': '<i class="fas fa-coins"></i>',
      'SOL': '<i class="fas fa-coins"></i>',
      'XRP': '<i class="fas fa-coins"></i>',
      'ADA': '<i class="fas fa-coins"></i>',
      'DOGE': '<i class="fas fa-dog"></i>'
    };

    // åœ‹æ——å°æ‡‰è¡¨
    const COUNTRY_FLAGS = {
      'USD': 'us',  // ç¾åœ‹
      'JPY': 'jp',  // æ—¥æœ¬
      'EUR': 'eu',  // æ­ç›Ÿ
      'GBP': 'gb',  // è‹±åœ‹
      'CNY': 'cn',  // ä¸­åœ‹
      'KRW': 'kr',  // éŸ“åœ‹
      'BNB': 'bn',  // æ±¶èŠ
      'AUD': 'au',  // æ¾³æ´²
      'CAD': 'ca',  // åŠ æ‹¿å¤§
      'CHF': 'ch',  // ç‘å£«
      'HKD': 'hk',  // é¦™æ¸¯
      'INR': 'in',  // å°åº¦
      'IDR': 'id',  // å°å°¼
      'MYR': 'my',  // é¦¬ä¾†è¥¿äº
      'NZD': 'nz',  // ç´è¥¿è˜­
      'PHP': 'ph',  // è²å¾‹è³“
      'SGD': 'sg',  // æ–°åŠ å¡
      'THB': 'th',  // æ³°åœ‹
      'VND': 'vn'   // è¶Šå—
    };

    // é è¨­åœ–ç¤º
    const DEFAULT_ICON = '<i class="fas fa-coins"></i>';

    // å¾localStorageè®€å–è²¨å¹£è¨­å®š
    function loadCurrencies() {
      const savedCurrencies = localStorage.getItem('currencies');
      if (savedCurrencies) {
        currencies = JSON.parse(savedCurrencies);
      } else {
        // å¦‚æœlocalStorageä¸­æ²’æœ‰æ•¸æ“šï¼Œä½¿ç”¨é è¨­å€¼
        currencies = {
          'TWD': { name: 'æ–°å°å¹£', rate: 1, time: new Date().toISOString() },
          'USD': { name: 'ç¾å…ƒ', rate: 0.033, time: new Date().toISOString() },
          'JPY': { name: 'æ—¥åœ“', rate: 3.7, time: new Date().toISOString() },
          'EUR': { name: 'æ­å…ƒ', rate: 0.03, time: new Date().toISOString() }
        };
        // ä¿å­˜é è¨­å€¼åˆ°localStorage
        localStorage.setItem('currencies', JSON.stringify(currencies));
      }
      console.log('å·²è¼‰å…¥è²¨å¹£è¨­å®š:', Object.keys(currencies));
    }

    // æ ¼å¼åŒ–æ—¥æœŸé¡¯ç¤º
    function formatDate(date) {
      const month = date.getMonth() + 1;
      const day = date.getDate();
      const hour = date.getHours();
      const minute = date.getMinutes();
      return `${month}/${day} ${hour}:${minute < 10 ? '0' + minute : minute}`;
    }

    function getCurrencyIcon(code) {
      // å¦‚æœæ˜¯åŠ å¯†è²¨å¹£ï¼Œä½¿ç”¨å°ˆç”¨åœ–ç¤º
      if (CURRENCY_ICONS[code]) {
        return CURRENCY_ICONS[code];
      }
      // å¦‚æœæœ‰åœ‹æ——å°æ‡‰ï¼Œä½¿ç”¨åœ‹æ——
      if (COUNTRY_FLAGS[code]) {
        return `<span class="flag-icon flag-icon-${COUNTRY_FLAGS[code]}"></span>`;
      }
      // å¦å‰‡ä½¿ç”¨é è¨­åœ–ç¤º
      return DEFAULT_ICON;
    }

    async function getExchangeRate(code) {
      // å¦‚æœæ˜¯åŠ å¯†è²¨å¹£ï¼Œä¾åºå˜—è©¦ä¸åŒ API
      if (CRYPTO_CURRENCIES[code]) {
        // å…ˆå˜—è©¦ CoinGecko
        try {
          const response = await fetch(API_SOURCES.COINGECKO.url(code));
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          const data = await response.json();
          if (data[CRYPTO_CURRENCIES[code]] && data[CRYPTO_CURRENCIES[code]].twd) {
            return API_SOURCES.COINGECKO.parse(data, code);
          }
        } catch (error) {
          console.error(`å¾ CoinGecko ç²å– ${code} åŒ¯ç‡å¤±æ•—:`, error);
        }

        // å¦‚æœ CoinGecko å¤±æ•—ï¼Œå˜—è©¦ Binance
        try {
          const response = await fetch(API_SOURCES.BINANCE.url(code));
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          const data = await response.json();
          if (data.price) {
            return await API_SOURCES.BINANCE.parse(data);
          }
        } catch (error) {
          console.error(`å¾ Binance ç²å– ${code} åŒ¯ç‡å¤±æ•—:`, error);
        }
      }

      // ä¸€èˆ¬è²¨å¹£ï¼Œä¾åºå˜—è©¦ä¸åŒ API
      for (const [key, api] of Object.entries(API_SOURCES)) {
        if (key === 'COINGECKO' || key === 'BINANCE') continue;

        try {
          const response = await fetch(api.url(code));
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          const data = await response.json();
          if (data.rates && data.rates.TWD) {
            return api.parse(data);
          }
        } catch (error) {
          console.error(`å¾ ${api.name} ç²å– ${code} åŒ¯ç‡å¤±æ•—:`, error);
        }
      }

      return null;
    }

    function loadCurrencyList() {
      const currencyListElement = document.getElementById('currencyList');
      if (!currencyListElement) return;
      
      currencyListElement.innerHTML = '';
      
      Object.entries(currencies).forEach(([code, data]) => {
        if (code === 'TWD') return; // è·³éå°å¹£
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>
            <div class="currency-list-item">
              <span class="currency-icon">${getCurrencyIcon(code)}</span>
              <span>${data.name} (${code})</span>
            </div>
          </td>
          <td>${data.rate.toFixed(2)}</td>
          <td>${new Date(data.time).toLocaleString()}</td>
          <td>
            <button class="currency-update-button" onclick="prepareUpdateRate('${code}')">ä¿®æ”¹</button>
            <button class="currency-select-button" onclick="deleteCurrency('${code}')">åˆªé™¤</button>
          </td>
        `;
        currencyListElement.appendChild(row);
      });
      
      // æª¢æŸ¥è²¨å¹£åˆ—è¡¨æ˜¯å¦ç‚ºç©º (é™¤äº†TWD)
      const nonTWDCurrencies = Object.keys(currencies).filter(code => code !== 'TWD');
      if (nonTWDCurrencies.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td colspan="4" class="currency-list-empty">å°šæœªè¨­å®šä»»ä½•è²¨å¹£ï¼Œè«‹é»æ“Šã€Œ+ æ–°å¢è²¨å¹£...ã€ä¾†æ·»åŠ </td>
        `;
        currencyListElement.appendChild(row);
      }
    }

    async function updateLiveRates() {
      try {
        const liveRatesList = document.getElementById('liveRates');
        liveRatesList.innerHTML = '';
        
        let successCount = 0;
        let totalCount = Object.keys(currencies).length;
        
        for (const [code, currencyData] of Object.entries(currencies)) {
          try {
            const rateData = await getExchangeRate(code);
            
            if (rateData && rateData.rate) {
              successCount++;
              const formattedTime = formatDate(new Date(rateData.time));
              
              const li = document.createElement('li');
              li.className = 'currency-live-rate-item';
              li.innerHTML = `
                <div class="currency-info">
                  <span class="currency-icon">${getCurrencyIcon(code)}</span>
                  <span class="currency-code">${code}</span>
                  <span class="currency-name">${currencyData.name}</span>
                </div>
                <div class="currency-rate-info">
                  <div class="currency-rate-value">
                    <span class="currency-live-rate">${rateData.rate.toFixed(2)}</span>
                    <span class="currency-set-rate">${currencyData.rate.toFixed(2)}</span>
                  </div>
                  <div class="currency-rate-time">${formattedTime}</div>
                </div>
              `;
              liveRatesList.appendChild(li);
            } else {
              // å¦‚æœ API å¤±æ•—ï¼Œåªé¡¯ç¤ºè¨­å®šçš„åŒ¯ç‡
              const li = document.createElement('li');
              li.className = 'currency-live-rate-item';
              li.innerHTML = `
                <div class="currency-info">
                  <span class="currency-icon">${getCurrencyIcon(code)}</span>
                  <span class="currency-code">${code}</span>
                  <span class="currency-name">${currencyData.name}</span>
                </div>
                <div class="currency-rate-info">
                  <div class="currency-rate-value">
                    <span class="currency-live-rate">ç„¡æ³•å–å¾—</span>
                    <span class="currency-set-rate">${currencyData.rate.toFixed(2)}</span>
                  </div>
                  <div class="currency-rate-time">${formatDate(new Date(currencyData.time))}</div>
                </div>
              `;
              liveRatesList.appendChild(li);
            }
          } catch (error) {
            console.error(`è™•ç† ${code} åŒ¯ç‡æ™‚ç™¼ç”ŸéŒ¯èª¤:`, error);
            // å¦‚æœç²å–å¤±æ•—ï¼Œåªé¡¯ç¤ºè¨­å®šçš„åŒ¯ç‡
            const li = document.createElement('li');
            li.className = 'currency-live-rate-item';
            li.innerHTML = `
              <div class="currency-info">
                <span class="currency-icon">${getCurrencyIcon(code)}</span>
                <span class="currency-code">${code}</span>
                <span class="currency-name">${currencyData.name}</span>
              </div>
              <div class="currency-rate-info">
                <div class="currency-rate-value">
                  <span class="currency-live-rate">ç„¡æ³•å–å¾—</span>
                  <span class="currency-set-rate">${currencyData.rate.toFixed(2)}</span>
                </div>
                <div class="currency-rate-time">${formatDate(new Date(currencyData.time))}</div>
              </div>
            `;
            liveRatesList.appendChild(li);
          }
        }
        
        // æ›´æ–°æ¶µè“‹ç‡è³‡è¨Š
        const coverageRate = (successCount / totalCount * 100).toFixed(1);
        document.getElementById('coverageRate').textContent = coverageRate + '%';
        
        document.getElementById('updateTime').textContent = `æœ€å¾Œæ›´æ–°ï¼š${formatDate(new Date())}`;
        
      } catch (error) {
        console.error('æ›´æ–°å³æ™‚åŒ¯ç‡å¤±æ•—:', error);
        alert('æ›´æ–°å³æ™‚åŒ¯ç‡å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
    }

    // æ›´æ–°è²¨å¹£é¸æ“‡ä¸‹æ‹‰é¸å–®
    function updateCurrencySelects() {
      // æ›´æ–°è½‰æ›å™¨çš„ä¾†æºè²¨å¹£é¸æ“‡
      const fromCurrencySelect = document.getElementById('fromCurrency');
      if (fromCurrencySelect) {
        const currentValue = fromCurrencySelect.value;
        fromCurrencySelect.innerHTML = '';
        
        // æ·»åŠ æ‰€æœ‰éå°å¹£çš„è²¨å¹£
        Object.entries(currencies).forEach(([code, data]) => {
          if (code !== 'TWD') {
            const option = document.createElement('option');
            option.value = code;
            option.textContent = `${data.name} (${code})`;
            fromCurrencySelect.appendChild(option);
          }
        });
        
        if (currentValue && currentValue !== 'TWD' && Object.keys(currencies).includes(currentValue)) {
          fromCurrencySelect.value = currentValue;
        }
      }
      
      // æ›´æ–°ä¿®æ”¹åŒ¯ç‡çš„é¸æ“‡æ¡†
      const editCurrencySelect = document.getElementById('editCurrency');
      const editCurrencyOptions = document.getElementById('editCurrencyOptions');
      
      if (editCurrencySelect && editCurrencyOptions) {
        // æ¸…ç©ºåŸæœ‰é¸é …ï¼Œä½†ä¿ç•™å‰å…©å€‹åŸºæœ¬é¸é …
        editCurrencySelect.innerHTML = '<option value="">è«‹é¸æ“‡è²¨å¹£</option><option value="new">+ æ–°å¢è²¨å¹£...</option>';
        // ç²å–ç¾æœ‰å­å…ƒç´ æ•¸é‡
        const childCount = editCurrencyOptions.children.length;
        // å¦‚æœå¤§æ–¼2ï¼ˆå³æœ‰é™¤äº†"è«‹é¸æ“‡"å’Œ"æ–°å¢"å¤–çš„é¸é …ï¼‰ï¼Œå‰‡ä¿ç•™å‰å…©å€‹ï¼Œåˆªé™¤å…¶ä»–
        if (childCount > 2) {
          // ä¿ç•™å‰å…©å€‹é¸é …ï¼Œå¾ç¬¬ä¸‰å€‹é–‹å§‹åˆªé™¤
          while (editCurrencyOptions.children.length > 2) {
            editCurrencyOptions.removeChild(editCurrencyOptions.lastChild);
          }
        }
        
        // æ·»åŠ æ‰€æœ‰éå°å¹£çš„è²¨å¹£
        Object.entries(currencies).forEach(([code, data]) => {
          if (code !== 'TWD') {
            // æ·»åŠ åˆ°éš±è—çš„selectå…ƒç´ 
            const option = document.createElement('option');
            option.value = code;
            option.textContent = `${data.name} (${code})`;
            editCurrencySelect.appendChild(option);
            
            // æ·»åŠ åˆ°è‡ªè¨‚ä¸‹æ‹‰é¸å–®
            const customOption = document.createElement('div');
            customOption.className = 'custom-select-option';
            customOption.setAttribute('data-value', code);
            customOption.innerHTML = `
              <span class="currency-icon">${getCurrencyIcon(code)}</span>
              <span>${data.name} (${code})</span>
            `;
            editCurrencyOptions.appendChild(customOption);
          }
        });
      }
    }

    // åˆå§‹åŒ–è‡ªè¨‚ä¸‹æ‹‰é¸å–®
    function initCustomSelect() {
      const editCurrencySelected = document.getElementById('editCurrencySelected');
      const editCurrencyOptions = document.getElementById('editCurrencyOptions');
      const editCurrency = document.getElementById('editCurrency');
      
      if (editCurrencySelected && editCurrencyOptions) {
        // é»æ“Šé¡¯ç¤º/éš±è—é¸é …
        editCurrencySelected.addEventListener('click', function() {
          editCurrencyOptions.classList.toggle('show');
        });
        
        // é»æ“Šé¸é …æ™‚
        editCurrencyOptions.addEventListener('click', function(e) {
          const option = e.target.closest('.custom-select-option');
          if (option) {
            const value = option.getAttribute('data-value');
            const text = option.textContent.trim();
            
            // æ›´æ–°é¡¯ç¤º
            if (value === 'new') {
              editCurrencySelected.innerHTML = `
                <span class="currency-icon"><i class="fas fa-plus-circle"></i></span>
                <span>æ–°å¢è²¨å¹£...</span>
              `;
            } else if (value === '') {
              editCurrencySelected.innerHTML = `<span>è«‹é¸æ“‡è²¨å¹£</span>`;
            } else {
              editCurrencySelected.innerHTML = option.innerHTML;
            }
            
            // æ›´æ–°hidden selectçš„å€¼
            editCurrency.value = value;
            
            // è§¸ç™¼changeäº‹ä»¶
            const event = new Event('change');
            editCurrency.dispatchEvent(event);
            
            // éš±è—é¸é …
            editCurrencyOptions.classList.remove('show');
          }
        });
        
        // é»æ“Šå…¶ä»–åœ°æ–¹æ™‚é—œé–‰é¸å–®
        document.addEventListener('click', function(e) {
          if (!editCurrencySelected.contains(e.target) && !editCurrencyOptions.contains(e.target)) {
            editCurrencyOptions.classList.remove('show');
          }
        });
      }
    }

    // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      loadCurrencies();
      loadCurrencyList();
      updateCurrencySelects();
      updateLiveRates();
      toggleShopeeOptions();
      
      // åˆå§‹åŒ–è‡ªè¨‚ä¸‹æ‹‰é¸å–®
      initCustomSelect();
      initConverterCustomSelect();
      generateCurrencyOptions();
      
      // å° editCurrency é¸æ“‡æ¡†æ·»åŠ  change äº‹ä»¶ç›£è½å™¨
      const editCurrencySelect = document.getElementById('editCurrency');
      if (editCurrencySelect) {
        editCurrencySelect.addEventListener('change', function() {
          const editRate = document.getElementById('editRate');
          const newCurrencyInputs = document.getElementById('newCurrencyInputs');
          const saveBtn = document.getElementById('saveCurrencyBtn');
          const deleteBtn = document.getElementById('deleteCurrencyBtn');
          
          if (this.value === 'new') {
            // é¡¯ç¤ºæ–°å¢è²¨å¹£çš„è¼¸å…¥æ¬„ä½
            newCurrencyInputs.style.display = 'block';
            editRate.value = '';
            saveBtn.innerHTML = 'æ–°å¢è²¨å¹£';
            saveBtn.onclick = saveCurrency;
            deleteBtn.style.display = 'none';
          } else if (this.value === '') {
            // æœªé¸æ“‡è²¨å¹£
            newCurrencyInputs.style.display = 'none';
            editRate.value = '';
            saveBtn.innerHTML = 'ä¿®æ”¹åŒ¯ç‡';
            saveBtn.onclick = editCurrencyRate;
            deleteBtn.style.display = 'none';
          } else {
            // é¡¯ç¤ºä¿®æ”¹åŒ¯ç‡ç•Œé¢
            newCurrencyInputs.style.display = 'none';
            saveBtn.innerHTML = 'ä¿®æ”¹åŒ¯ç‡';
            saveBtn.onclick = editCurrencyRate;
            
            // é¡¯ç¤ºåˆªé™¤æŒ‰éˆ•
            deleteBtn.style.display = 'inline-block';
            deleteBtn.onclick = function() {
              deleteCurrency(editCurrencySelect.value);
            };
            
            if (this.value && currencies[this.value]) {
              editRate.value = currencies[this.value].rate;
            } else {
              editRate.value = '';
            }
          }
        });
      }
    });

    // åˆ‡æ›æ¨™ç±¤é 
    function switchTab(tabId) {
      // éš±è—æ‰€æœ‰æ¨™ç±¤å…§å®¹
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // å–æ¶ˆæ¿€æ´»æ‰€æœ‰æ¨™ç±¤æŒ‰éˆ•
      document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
      });
      
      // é¡¯ç¤ºé¸ä¸­çš„æ¨™ç±¤å…§å®¹
      document.getElementById(tabId).classList.add('active');
      
      // æ¿€æ´»å°æ‡‰çš„æ¨™ç±¤æŒ‰éˆ•
      document.querySelector(`.tab-button[onclick="switchTab('${tabId}')"]`).classList.add('active');
    }

    function deleteCurrency(code) {
      if (code === 'TWD') {
        alert('ç„¡æ³•åˆªé™¤åŸºæº–è²¨å¹£ï¼ˆæ–°å°å¹£ï¼‰');
        return;
      }

      if (confirm(`ç¢ºå®šè¦åˆªé™¤ ${currencies[code].name} (${code}) å—ï¼Ÿ`)) {
        delete currencies[code];
        localStorage.setItem('currencies', JSON.stringify(currencies));
        
        // æ›´æ–°ç•Œé¢
        loadCurrencyList();
        updateCurrencySelects();
        
        // åˆ·æ–°é é¢ä»¥ç¢ºä¿æ‰€æœ‰çµ„ä»¶éƒ½è¢«æ­£ç¢ºæ›´æ–°
        location.reload();
      }
    }

    async function updateSingleRate(code) {
      try {
        const rate = await getExchangeRate(code);
        if (rate && rate.rate) {
          currencies[code].rate = rate.rate;
          currencies[code].time = rate.time || new Date().toISOString();
          localStorage.setItem('currencies', JSON.stringify(currencies));
          loadCurrencyList();
          alert(`å·²æ›´æ–° ${currencies[code].name} (${code}) åŒ¯ç‡ç‚º ${rate.rate.toFixed(4)}`);
        } else {
          alert(`ç„¡æ³•ç²å– ${currencies[code].name} (${code}) çš„å³æ™‚åŒ¯ç‡ï¼Œè«‹ç¨å¾Œå†è©¦`);
        }
      } catch (error) {
        console.error('æ›´æ–°åŒ¯ç‡å¤±æ•—:', error);
        alert('æ›´æ–°åŒ¯ç‡å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
    }

    // ä¿®æ”¹è²¨å¹£åŒ¯ç‡
    function editCurrencyRate() {
      const code = document.getElementById('editCurrency').value;
      const rate = parseFloat(document.getElementById('editRate').value);
      
      if (!code) {
        alert('è«‹é¸æ“‡è¦ä¿®æ”¹çš„è²¨å¹£');
        return;
      }
      
      if (isNaN(rate) || rate <= 0) {
        alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„åŒ¯ç‡');
        return;
      }
      
      // æ›´æ–°è²¨å¹£åŒ¯ç‡
      currencies[code].rate = rate;
      currencies[code].time = new Date().toISOString();
      
      localStorage.setItem('currencies', JSON.stringify(currencies));
      
      // æ›´æ–°ç•Œé¢
      loadCurrencyList();
      updateCurrencySelects();
      
      // æ¸…ç©ºè¼¸å…¥
      document.getElementById('editCurrency').value = '';
      document.getElementById('editRate').value = '';
      
      alert(`å·²æˆåŠŸä¿®æ”¹ ${currencies[code].name} (${code}) åŒ¯ç‡ç‚º ${rate}`);
      
      // åˆ·æ–°é é¢
      location.reload();
    }

    // è¨ˆç®—åŒ¯ç‡è½‰æ›
    function calculate() {
      const fromCurrency = document.getElementById("fromCurrency").value;
      const amount = parseFloat(document.getElementById("amount").value);
      const toCurrency = 'TWD'; // å›ºå®šè½‰æ›åˆ°å°å¹£

      if (isNaN(amount) || amount <= 0) {
        alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡');
        return;
      }

      if (!fromCurrency) {
        alert('è«‹é¸æ“‡è²¨å¹£');
        return;
      }

      // å¤–å¹£è½‰å°å¹£
      const exchangeRate = currencies[fromCurrency].rate;
      const result = Math.ceil(amount * exchangeRate); // ç„¡æ¢ä»¶é€²ä½åˆ°æ•´æ•¸

      // é¡¯ç¤ºçµæœ
      let resultMessage = `
        <p><span>è½‰æ›é‡‘é¡ï¼š</span><span style="float: right;">${result} ${toCurrency}</span></p>
        <p><span>åŒ¯ç‡ï¼š</span><span style="float: right;">1 ${fromCurrency} = ${currencies[fromCurrency].rate.toFixed(2)} ${toCurrency}</span></p>
        <p>åŒ¯ç‡æ›´æ–°æ™‚é–“: ${new Date(currencies[fromCurrency].time).toLocaleString()}</p>
      `;
      
      document.getElementById('currencyResult').innerHTML = resultMessage;
    }

    // æº–å‚™æ›´æ–°åŒ¯ç‡
    function prepareUpdateRate(code) {
      const editCurrencySelect = document.getElementById('editCurrency');
      const editRate = document.getElementById('editRate');
      const saveBtn = document.getElementById('saveCurrencyBtn');
      const editCurrencySelected = document.getElementById('editCurrencySelected');
      const editCurrencyOptions = document.getElementById('editCurrencyOptions');
      
      // é¸æ“‡è¦ä¿®æ”¹çš„è²¨å¹£
      editCurrencySelect.value = code;
      
      // æ›´æ–°è‡ªè¨‚ä¸‹æ‹‰é¸å–®é¡¯ç¤º
      const selectedOption = Array.from(editCurrencyOptions.children).find(option => option.getAttribute('data-value') === code);
      if (selectedOption) {
        editCurrencySelected.innerHTML = selectedOption.innerHTML;
      }
      
      // å¡«å…¥ç•¶å‰åŒ¯ç‡
      if (currencies[code]) {
        editRate.value = currencies[code].rate;
      }
      
      // è¨­ç½®æŒ‰éˆ•
      const newCurrencyInputs = document.getElementById('newCurrencyInputs');
      newCurrencyInputs.style.display = 'none';
      saveBtn.innerHTML = 'ä¿®æ”¹åŒ¯ç‡';
      saveBtn.onclick = editCurrencyRate;
      
      // åˆ‡æ›åˆ°è¨­å®šé é¢
      switchTab('settings');
      
      // æ»¾å‹•åˆ°ç·¨è¼¯å€åŸŸ
      editCurrencySelect.scrollIntoView({ behavior: 'smooth' });
    }

    // å„²å­˜æ–°è²¨å¹£
    function saveCurrency() {
      // å–å¾—è‡ªè¨‚è²¨å¹£è³‡è¨Š
      const code = document.getElementById('customCode').value.trim().toUpperCase();
      const name = document.getElementById('customName').value.trim();
      
      if (!code || code.length < 3) {
        alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„è²¨å¹£ä»£ç¢¼ï¼ˆè‡³å°‘3å€‹å­—ç¬¦ï¼‰');
        return;
      }
      
      if (!name) {
        alert('è«‹è¼¸å…¥è²¨å¹£åç¨±');
        return;
      }
      
      // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
      if (currencies[code]) {
        if (!confirm(`${name} (${code}) å·²å­˜åœ¨ï¼Œç¢ºå®šè¦è¦†è“‹å—ï¼Ÿ`)) {
          return;
        }
      }
      
      const rate = parseFloat(document.getElementById('editRate').value);
      if (isNaN(rate) || rate <= 0) {
        alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„åŒ¯ç‡');
        return;
      }

      // å„²å­˜è²¨å¹£
      currencies[code] = {
        name: name,
        rate: rate,
        time: new Date().toISOString()
      };

      localStorage.setItem('currencies', JSON.stringify(currencies));
      
      // æ›´æ–°ç•Œé¢
      loadCurrencyList();
      updateCurrencySelects();
      
      // æ¸…ç©ºè¼¸å…¥
      document.getElementById('customCode').value = '';
      document.getElementById('customName').value = '';
      document.getElementById('editRate').value = '';
      document.getElementById('editCurrency').value = '';
      document.getElementById('newCurrencyInputs').style.display = 'none';
      
      // æ¢å¾©æŒ‰éˆ•æ–‡å­—å’ŒåŠŸèƒ½
      const saveBtn = document.getElementById('saveCurrencyBtn');
      saveBtn.innerHTML = 'ä¿®æ”¹åŒ¯ç‡';
      saveBtn.onclick = editCurrencyRate;
      
      alert(`å·²æˆåŠŸæ–°å¢ ${name} (${code}) åŒ¯ç‡`);
      
      // åˆ·æ–°é é¢
      location.reload();
    }

    // åˆ‡æ›è¦çš®é¸é …çš„é¡¯ç¤º/éš±è—
    function toggleShopeeOptions() {
      const platform = document.getElementById("platform").value;
      const shopeeOptions = document.getElementById("shopeeOptions");
      if (platform === "shopee") {
        shopeeOptions.classList.remove('hidden');
      } else {
        shopeeOptions.classList.add('hidden');
      }
    }

    function handleCoinRewardChange(checkbox) {
      const coinReward = document.getElementById("coinReward");
      const coinReward15 = document.getElementById("coinReward15");
      
      if (checkbox.id === "coinReward") {
        if (checkbox.checked) {
          coinReward15.checked = false;
        }
      } else {
        if (checkbox.checked) {
          coinReward.checked = false;
        }
      }
    }

    function calculateAll() {
      const vatRate = 0.05;
      const incomeTaxRate = 0.2;

      let price = parseFloat(document.getElementById("price").value);
      let cost = parseFloat(document.getElementById("cost").value);
      let targetProfitPercent = parseFloat(document.getElementById("targetProfitPercent").value);
      let targetProfit;

      // è¨ˆç®—è¦çš®è²»ç”¨
      const platform = document.getElementById("platform").value;
      let shopeeFees = 0;
      let shopeeFeesBreakdown = [];
      let shopeeFeeRate = 0;

      if (platform === "shopee") {
        if (document.getElementById("transactionFee").checked) {
          shopeeFeeRate += 0.055;
        }
        
        if (document.getElementById("coinReward").checked) {
          shopeeFeeRate += 0.03;
        }
        
        if (document.getElementById("coinReward15").checked) {
          shopeeFeeRate += 0.015;
        }
        
        if (document.getElementById("freeShipping").checked) {
          shopeeFeeRate += 0.07;
          if (document.getElementById("coinReward").checked || document.getElementById("coinReward15").checked) {
            shopeeFeeRate -= 0.005;
          }
        }
        
        if (document.getElementById("processingFee").checked) {
          shopeeFeeRate += 0.02;
        }
      }

      if (!isNaN(targetProfitPercent) && targetProfitPercent > 0) {
        targetProfit = cost * (targetProfitPercent / 100);
      }

      if (!price && cost && !isNaN(targetProfit)) {
        const grossProfit = targetProfit / (1 - incomeTaxRate);
        const revenueExVAT = cost + grossProfit;
        price = parseFloat((revenueExVAT * (1 + vatRate) / (1 - shopeeFeeRate)).toFixed(2));
      }

      if (platform === "shopee" && price) {
        if (document.getElementById("transactionFee").checked) {
          const transactionFee = price * 0.055;
          shopeeFees += transactionFee;
          shopeeFeesBreakdown.push(`æˆäº¤æ‰‹çºŒè²»ï¼š${transactionFee.toFixed(2)} å…ƒ (5.5%)`);
        }
        
        if (document.getElementById("coinReward").checked) {
          const otherServiceFee = price * 0.03;
          shopeeFees += otherServiceFee;
          shopeeFeesBreakdown.push(`è¦å¹£å›é¥‹å°ˆæ¡ˆï¼š${otherServiceFee.toFixed(2)} å…ƒ (3%)`);
        }
        
        if (document.getElementById("coinReward15").checked) {
          const otherServiceFee = price * 0.015;
          shopeeFees += otherServiceFee;
          shopeeFeesBreakdown.push(`è¦å¹£å›é¥‹å°ˆæ¡ˆï¼š${otherServiceFee.toFixed(2)} å…ƒ (1.5%)`);
        }
        
        if (document.getElementById("freeShipping").checked) {
          const freeShippingFee = price * 0.07;
          shopeeFees += freeShippingFee;
          if (document.getElementById("coinReward").checked || document.getElementById("coinReward15").checked) {
            shopeeFees -= price * 0.005;
            shopeeFeesBreakdown.push(`å…é‹è£œè²¼ï¼š${freeShippingFee.toFixed(2)} å…ƒ (7%) - 0.5% å„ªæƒ `);
          } else {
            shopeeFeesBreakdown.push(`å…é‹è£œè²¼ï¼š${freeShippingFee.toFixed(2)} å…ƒ (7%)`);
          }
        }
        
        if (document.getElementById("processingFee").checked) {
          const processingFee = price * 0.02;
          shopeeFees += processingFee;
          shopeeFeesBreakdown.push(`é‡‘æµèˆ‡ç³»çµ±è™•ç†è²»ï¼š${processingFee.toFixed(2)} å…ƒ (2%)`);
        }
      }

      if (price && cost) {
        let priceAfterShopee = price;
        if (platform === "shopee") {
          priceAfterShopee -= shopeeFees;
        }
        
        const revenue = priceAfterShopee / (1 + vatRate);
        const vat = priceAfterShopee - revenue;
        
        const grossProfit = revenue - cost;
        const incomeTax = grossProfit * incomeTaxRate;
        const netProfit = grossProfit - incomeTax;
        const netProfitRateCost = (netProfit / cost) * 100;
        const netProfitRatePrice = (netProfit / price) * 100;

        let resultHTML = `
          <div class="result-header">
            âœ… <b>è‡ªå‹•è¨ˆç®—çµæœï¼š</b><br>
            â–¸ å«ç¨…å”®åƒ¹ï¼š<b>${price.toFixed(2)}</b> å…ƒ<br>
            â–¸ é ä¼°è¨‚å–®é€²å¸³ï¼š<b>${priceAfterShopee.toFixed(2)}</b> å…ƒ
          </div>
          <div class="result-content">
            <div class="fee-section">
              <h3>ğŸ“¤ æ”¯å‡ºé …ç›®</h3>
        `;

        if (platform === "shopee" && shopeeFees > 0) {
          resultHTML += `
              <div class="shopee-fees-container">
                <span class="fee-text shopee-fees-toggle" onclick="toggleShopeeFeesDetail(this)">
                  âŒ è¦çš®è²»ç”¨ç¸½è¨ˆï¼š<b>${shopeeFees.toFixed(2)}</b> å…ƒ <span class="toggle-icon">â–¼</span>
                </span>
                <div class="shopee-fees-detail" style="display: none;">
                  ${shopeeFeesBreakdown.map(fee => `<span class="shopee-fee-detail">ã€€ã€€${fee}</span>`).join('<br>')}
                </div>
              </div>
          `;
        }

        resultHTML += `
              <span class="fee-text">âŒ ç‡Ÿæ¥­ç¨…ï¼ˆ5%ï¼‰ï¼š<b>${vat.toFixed(2)}</b> å…ƒ</span><br>
              <span class="fee-text">âŒ ç‡Ÿæ‰€ç¨…ï¼ˆ20%ï¼‰ï¼š<b>${incomeTax.toFixed(2)}</b> å…ƒ</span>
            </div>
            <div class="profit-section">
              <h3>ğŸ“¥ æ”¶ç›Šé …ç›®</h3>
              <span class="profit-text">ğŸŸ¢ æ¯›åˆ©ï¼š<b>${grossProfit.toFixed(2)}</b> å…ƒ</span><br>
              <span class="profit-text-bold net-profit">ğŸŸ¢ ç¨…å¾Œæ·¨åˆ©ï¼š<b>${netProfit.toFixed(2)}</b> å…ƒ</span><br>
              <hr class="divider">
              ğŸ’° æ·¨åˆ©ä½”æˆæœ¬ï¼š<b class="profit-text">${netProfitRateCost.toFixed(2)}%</b><br>
              ğŸ’° æ·¨åˆ©ä½”å”®åƒ¹ï¼š<b class="profit-text">${netProfitRatePrice.toFixed(2)}%</b>
            </div>
          </div>
        `;

        document.getElementById("priceResult").innerHTML = resultHTML;
      } else {
        document.getElementById("priceResult").innerHTML = "â—è«‹è‡³å°‘è¼¸å…¥æˆæœ¬ï¼Œä¸¦è¼¸å…¥å”®åƒ¹æˆ–æƒ³è¦çš„åˆ©æ½¤ç‡ã€‚";
      }
    }

    function toggleShopeeFeesDetail(element) {
      const detailElement = element.parentElement.querySelector('.shopee-fees-detail');
      const toggleIcon = element.querySelector('.toggle-icon');
      if (detailElement.style.display === 'none') {
        detailElement.style.display = 'block';
        toggleIcon.textContent = 'â–²';
      } else {
        detailElement.style.display = 'none';
        toggleIcon.textContent = 'â–¼';
      }
    }

    // ä¿®æ”¹ generateCurrencyOptions å‡½æ•¸ï¼Œæ”¯æ´è‡ªè¨‚ä¸‹æ‹‰é¸å–®
    function generateCurrencyOptions() {
      const fromCurrencySelect = document.getElementById('fromCurrency');
      const fromCurrencyOptions = document.getElementById('fromCurrencyOptions');
      
      // æ¸…ç©ºç¾æœ‰é¸é …
      fromCurrencySelect.innerHTML = '';
      fromCurrencyOptions.innerHTML = '';
      
      // æ·»åŠ æ–°é¸é …ï¼Œå¸¶æœ‰åœ–æ¨™
      Object.keys(currencies).sort().forEach(code => {
        if (code !== 'TWD') {
          const currency = currencies[code];
          const icon = getCurrencyIcon(code);
          
          // ç‚ºéš±è—çš„ select æ·»åŠ é¸é …
          const option = document.createElement('option');
          option.value = code;
          option.textContent = `${currency.name} (${code})`;
          fromCurrencySelect.appendChild(option);
          
          // ç‚ºè‡ªè¨‚ä¸‹æ‹‰é¸å–®æ·»åŠ é¸é …
          const customOption = document.createElement('div');
          customOption.className = 'custom-select-option';
          customOption.setAttribute('data-value', code);
          customOption.innerHTML = `
            <span class="currency-icon">${icon}</span>
            <span>${currency.name} (${code})</span>
          `;
          fromCurrencyOptions.appendChild(customOption);
        }
      });
    }

    // åˆå§‹åŒ–è²¨å¹£è½‰æ›å™¨çš„è‡ªè¨‚ä¸‹æ‹‰é¸å–®
    function initConverterCustomSelect() {
      const fromCurrencySelected = document.getElementById('fromCurrencySelected');
      const fromCurrencyOptions = document.getElementById('fromCurrencyOptions');
      const fromCurrency = document.getElementById('fromCurrency');
      
      if (fromCurrencySelected && fromCurrencyOptions) {
        // é»æ“Šé¡¯ç¤º/éš±è—é¸é …
        fromCurrencySelected.addEventListener('click', function() {
          fromCurrencyOptions.classList.toggle('show');
        });
        
        // é»æ“Šé¸é …æ™‚
        fromCurrencyOptions.addEventListener('click', function(e) {
          const option = e.target.closest('.custom-select-option');
          if (option) {
            const value = option.getAttribute('data-value');
            
            // æ›´æ–°é¡¯ç¤º
            fromCurrencySelected.innerHTML = option.innerHTML;
            
            // æ›´æ–°hidden selectçš„å€¼
            fromCurrency.value = value;
            
            // éš±è—é¸é …
            fromCurrencyOptions.classList.remove('show');
          }
        });
        
        // é»æ“Šå…¶ä»–åœ°æ–¹æ™‚é—œé–‰é¸å–®
        document.addEventListener('click', function(e) {
          if (!fromCurrencySelected.contains(e.target) && !fromCurrencyOptions.contains(e.target)) {
            fromCurrencyOptions.classList.remove('show');
          }
        });
      }
    }
  </script>
</body>
</html>